# Demo Application consuming IstioEnricher

This is a basic application which would be showcasing how user can integrate its own enricher with Eclipse JKube Kubernetes Gradle Plugin. 

## Prerequisite
You need to build `istio-enricher` module in `istio-enricher/` directory and publish it to local maven repository in order to use it from this module.

## Adding Enricher as Plugin dependency

Enricher dependency needs to be declared in gradle buildscript dependencies:
```groovy
buildscript {
    repositories {
        mavenLocal()
    }
    dependencies {
        classpath('org.eclipse.jkube.quickstarts.kit.enricher.istio:istio-enricher:1.8.0-SNAPSHOT')
    }
}
```

## Adding Enricher as Compile time dependency

You can also configure Eclipse JKube Kubernetes Gradle Plugin to look into project dependencies for potential enrichers. This can be done via setting `useProjectClassPath` flag to `true`. Here is an example:

```groovy
dependencies {
    // Enricher Dependency
    compileOnly 'org.eclipse.jkube.quickstarts.kit.enricher.istio:istio-enricher:1.8.0-SNAPSHOT'
}

kubernetes {
    // Also look into project class path for enrichers/generators
    useProjectClassPath = true
    // ...
}
```

## Using the Enricher
If you'll run `gradle k8sResource`, you'll see enricher kicks in during the resource generation phase:
```
 $ gradle k8sResource

> Task :k8sResource
k8s: Cannot access cluster for detecting mode: No route to host (Host unreachable)
k8s: Running in Kubernetes modes
k8s: Running generator spring-boot
k8s: istio-enricher: Added dummy networking.istio.io/v1alpha3 Gateway
k8s: istio-enricher: Exiting Istio Enricher
```

Inspect the resources generated by plugin, you should be able to see Istio Gateway resource added by enricher:
```sh
$ cat build/classes/java/main/META-INF/jkube/kubernetes/jkube-gradle-sample-custom-istio-enricher-app-cr.yml 
---
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  labels:
    app: jkube-gradle-sample-custom-istio-enricher-app
    provider: jkube
    version: 0.0.1-SNAPSHOT
    group: org.eclipse.jkube.quickstarts.gradle
  name: jkube-gradle-sample-custom-istio-enricher-app
spec:
  selector:
    app: test-app
  servers:
  - hosts:
    - uk.bookinfo.com
    - in.bookinfo.com
    port:
      name: http
      number: 80
      protocol: HTTP
    tls:
      httpsRedirect: true
```
